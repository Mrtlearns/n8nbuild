# =========================
# FILE: .github/workflows/build-wheels-scheduled.yml
# =========================
name: Build custom n8n runners (pdflib) - smart latest

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force rebuild even if upstream n8nio/runners:latest digest is unchanged"
        required: false
        default: "false"
  schedule:
    - cron: "17 */6 * * *" # every 6 hours
  push:
    paths:
      - "runners/**"
      - ".github/workflows/build-wheels-scheduled.yml"
      # IMPORTANT: do NOT include latest-runner-digest.txt or wheel-metadata.json here,
      # because the workflow commits those files itself.

permissions:
  contents: write
  packages: write

env:
  DOCKERHUB_REPO: "n8nio/runners"
  DOCKERHUB_TAG: "latest"
  GHCR_WHEELHOUSE_IMAGE: "ghcr.io/mrtlearns/n8n-runner-wheelhouse"
  GHCR_RUNNERS_IMAGE: "ghcr.io/mrtlearns/n8n-runners-pdflib"

jobs:
  build:
    runs-on: ubuntu-latest

    # Extra guard in case something ever causes a push-trigger loop
    if: github.event_name != 'push' || github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------
      # 1) Detect upstream change: Docker Hub manifest digest for n8nio/runners:latest
      #    Uses Registry token flow + HEAD request and reads Docker-Content-Digest header.
      # -------------------------
      - name: Get remote digest for docker.io/n8nio/runners:latest (no pull)
        id: upstream
        shell: bash
        run: |
          set -euo pipefail

          TOKEN="$(curl -fsSL \
            "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${DOCKERHUB_REPO}:pull" \
            | jq -r '.token')"

          REMOTE_DIGEST="$(curl -fsSI \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.docker.distribution.manifest.list.v2+json" \
            "https://registry-1.docker.io/v2/${DOCKERHUB_REPO}/manifests/${DOCKERHUB_TAG}" \
            | tr -d '\r' \
            | awk -F': ' 'tolower($1)=="docker-content-digest"{print $2}' \
            | tail -n 1)"

          if [[ -z "${REMOTE_DIGEST}" ]]; then
            echo "Failed to detect remote digest (empty)."
            exit 1
          fi

          echo "REMOTE_DIGEST=${REMOTE_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "Remote digest: ${REMOTE_DIGEST}"

      - name: Read stored digest (repo file)
        id: stored
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f latest-runner-digest.txt ]]; then
            STORED_DIGEST="$(tr -d '\r\n' < latest-runner-digest.txt || true)"
          else
            STORED_DIGEST=""
          fi
          echo "STORED_DIGEST=${STORED_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "Stored digest: ${STORED_DIGEST}"

      - name: Decide whether upstream changed
        id: decide_upstream
        shell: bash
        run: |
          set -euo pipefail
          BASE_CHANGED="false"
          if [[ "${{ steps.stored.outputs.STORED_DIGEST }}" != "${{ steps.upstream.outputs.REMOTE_DIGEST }}" ]]; then
            BASE_CHANGED="true"
          fi
          echo "BASE_CHANGED=${BASE_CHANGED}" >> "$GITHUB_OUTPUT"
          echo "BASE_CHANGED=${BASE_CHANGED}"

      # -------------------------
      # 2) Determine Python ABI from CURRENT upstream image (pull + inspect via python in the venv)
      # -------------------------
      - name: Pull upstream n8nio/runners:latest (for ABI probe)
        run: docker pull docker.io/n8nio/runners:latest

      - name: Get Python ABI (SOABI) from upstream runner image
        id: abi
        shell: bash
        run: |
          set -euo pipefail

          ABI_JSON="$(
            docker run --rm docker.io/n8nio/runners:latest \
              /opt/runners/task-runner-python/.venv/bin/python - <<'PY'
import json, sys, sysconfig
print(json.dumps({
  "py": f"{sys.version_info.major}.{sys.version_info.minor}",
  "soabi": (sysconfig.get_config_var("SOABI") or "")
}))
PY
          )"

          echo "${ABI_JSON}" > abi.json
          PY_VER="$(jq -r '.py' abi.json)"
          SOABI="$(jq -r '.soabi' abi.json)"

          if [[ -z "${SOABI}" || "${SOABI}" == "null" ]]; then
            SAFE_TAG="py${PY_VER}"
          else
            SAFE_TAG="$(echo "${SOABI}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_.-]/-/g')"
          fi

          echo "PY_VER=${PY_VER}" >> "$GITHUB_OUTPUT"
          echo "SOABI=${SOABI}" >> "$GITHUB_OUTPUT"
          echo "WHEEL_TAG=${SAFE_TAG}" >> "$GITHUB_OUTPUT"

          echo "PY_VER=${PY_VER}"
          echo "SOABI=${SOABI}"
          echo "WHEEL_TAG=${SAFE_TAG}"


      # -------------------------
      # 3) Decide if we should do any work this run
      #    - On schedule: build ONLY if upstream base changed
      #    - On push: always build (you changed code)
      #    - On workflow_dispatch: build if force=true OR upstream changed
      # -------------------------
      - name: Compute SHOULD_BUILD gate
        id: gate
        shell: bash
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"
          FORCE_INPUT="${{ github.event.inputs.force || 'false' }}"
          BASE_CHANGED="${{ steps.decide_upstream.outputs.BASE_CHANGED }}"

          SHOULD_BUILD="false"

          if [[ "${EVENT}" == "push" ]]; then
            SHOULD_BUILD="true"
          elif [[ "${EVENT}" == "workflow_dispatch" ]]; then
            if [[ "${FORCE_INPUT}" == "true" || "${BASE_CHANGED}" == "true" ]]; then
              SHOULD_BUILD="true"
            fi
          else
            if [[ "${BASE_CHANGED}" == "true" ]]; then
              SHOULD_BUILD="true"
            fi
          fi

          echo "SHOULD_BUILD=${SHOULD_BUILD}" >> "$GITHUB_OUTPUT"
          echo "Event=${EVENT} Force=${FORCE_INPUT} BaseChanged=${BASE_CHANGED} => SHOULD_BUILD=${SHOULD_BUILD}"

      - name: Exit early (no upstream change)
        if: steps.gate.outputs.SHOULD_BUILD != 'true'
        run: |
          echo "No new docker.io/n8nio/runners:latest detected (and no push/manual force). Skipping build."
          exit 0

      # -------------------------
      # 4) Decide if wheelhouse rebuild is needed (ABI/reqs changed OR wheelhouse tag missing)
      # -------------------------
      - name: Compute requirements hash
        id: reqhash
        shell: bash
        run: |
          set -euo pipefail
          REQ_SHA="$(sha256sum runners/requirements-wheels.txt | awk '{print $1}')"
          echo "REQ_SHA=${REQ_SHA}" >> "$GITHUB_OUTPUT"
          echo "REQ_SHA=${REQ_SHA}"

      - name: Read stored wheel metadata (repo file)
        id: wheelmeta
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f wheel-metadata.json ]]; then
            STORED_SOABI="$(jq -r '.soabi // ""' wheel-metadata.json)"
            STORED_REQ_SHA="$(jq -r '.requirements_sha256 // ""' wheel-metadata.json)"
          else
            STORED_SOABI=""
            STORED_REQ_SHA=""
          fi
          echo "STORED_SOABI=${STORED_SOABI}" >> "$GITHUB_OUTPUT"
          echo "STORED_REQ_SHA=${STORED_REQ_SHA}" >> "$GITHUB_OUTPUT"
          echo "Stored soabi=${STORED_SOABI}"
          echo "Stored reqsha=${STORED_REQ_SHA}"

      - name: Check if wheelhouse image tag exists in GHCR
        id: wheelhouse_exists
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.abi.outputs.WHEEL_TAG }}"
          if docker manifest inspect "${GHCR_WHEELHOUSE_IMAGE}:${TAG}" >/dev/null 2>&1; then
            echo "EXISTS=true" >> "$GITHUB_OUTPUT"
          else
            echo "EXISTS=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Decide wheelhouse rebuild
        id: wheelhouse_gate
        shell: bash
        run: |
          set -euo pipefail
          NEED="false"

          if [[ "${{ steps.wheelmeta.outputs.STORED_SOABI }}" != "${{ steps.abi.outputs.SOABI }}" ]]; then
            NEED="true"
          fi
          if [[ "${{ steps.wheelmeta.outputs.STORED_REQ_SHA }}" != "${{ steps.reqhash.outputs.REQ_SHA }}" ]]; then
            NEED="true"
          fi
          if [[ "${{ steps.wheelhouse_exists.outputs.EXISTS }}" != "true" ]]; then
            NEED="true"
          fi

          echo "REBUILD_WHEELHOUSE=${NEED}" >> "$GITHUB_OUTPUT"
          echo "REBUILD_WHEELHOUSE=${NEED}"

      # -------------------------
      # 5) Build & push wheelhouse image (only when needed)
      # -------------------------
      - name: Build and push wheelhouse image
        if: steps.wheelhouse_gate.outputs.REBUILD_WHEELHOUSE == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: runners/wheelhouse.Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_WHEELHOUSE_IMAGE }}:${{ steps.abi.outputs.WHEEL_TAG }}
            ${{ env.GHCR_WHEELHOUSE_IMAGE }}:latest

      # -------------------------
      # 6) Build & push final runner image (uses wheelhouse via build-arg)
      # -------------------------
      - name: Build and push final runners image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: runners/Dockerfile
          push: true
          build-args: |
            WHEELHOUSE_IMAGE=${{ env.GHCR_WHEELHOUSE_IMAGE }}:${{ steps.abi.outputs.WHEEL_TAG }}
          tags: |
            ${{ env.GHCR_RUNNERS_IMAGE }}:latest

      # -------------------------
      # 7) Update repo state files (digest + metadata) and commit
      # -------------------------
      - name: Update state files
        shell: bash
        run: |
          set -euo pipefail

          echo "${{ steps.upstream.outputs.REMOTE_DIGEST }}" > latest-runner-digest.txt

          cat > wheel-metadata.json <<EOF
{
  "python_version": "${{ steps.abi.outputs.PY_VER }}",
  "soabi": "${{ steps.abi.outputs.SOABI }}",
  "wheel_tag": "${{ steps.abi.outputs.WHEEL_TAG }}",
  "requirements_sha256": "${{ steps.reqhash.outputs.REQ_SHA }}",
  "upstream_runners_digest": "${{ steps.upstream.outputs.REMOTE_DIGEST }}"
}
EOF

      - name: Commit state updates
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add latest-runner-digest.txt wheel-metadata.json

          if git diff --cached --quiet; then
            echo "No state changes to commit."
            exit 0
          fi

          git commit -m "Update upstream digest + wheel metadata [skip ci]"
          git push
